{
  "template_info": {
    "name": "PGE 2B FFB Analysis Report - Corrected Structure",
    "version": "6.0",
    "description": "FFB Scanner Analysis with proper query structure based on reference implementation",
    "estate": "PGE 2B",
    "created_date": "2025-11-01",
    "last_modified": "2025-11-01 11:10:00",
    "correction_notes": "Fixed corrupted SQL syntax. Based on gui_multi_estate_ffb_analysis.py structure."
  },
  "data_sources": {
    "ffb_scanner_data": "FFBSCANNERDATA{month:02d}",
    "employee_data": "EMP",
    "division_data": "CRDIVISION",
    "field_data": "OCFIELD"
  },
  "queries": {
    "employee_mapping": {
      "description": "Get employee ID to name mapping from EMP table",
      "sql": "SELECT DISTINCT \"ID EMPCODE\" as EMPID, \"ID NAME\" as EMPNAME FROM EMP WHERE \"ID EMPCODE\" IS NOT NULL AND \"ID NAME\" IS NOT NULL",
      "cache": true
    },
    "division_list": {
      "description": "Get divisions using proper JOIN with OCFIELD and CRDIVISION",
      "sql": "SELECT DISTINCT b.DIVID, c.DIVNAME \n                         FROM FFBSCANNERDATA{month:02d} a \n                         LEFT JOIN OCFIELD b ON a.FIELDID = b.ID \n                         LEFT JOIN CRDIVISION c ON b.DIVID = c.ID \n                         WHERE b.DIVID IS NOT NULL AND c.DIVNAME IS NOT NULL \n                         ORDER BY b.DIVID",
      "parameters": [
        "month"
      ]
    },
    "raw_ffb_data": {
      "description": "Extract raw FFB scanner data with proper field structure",
      "sql": "SELECT a.ID, a.SCANUSERID, a.OCID, a.WORKERID, a.CARRIERID, \n                                a.FIELDID, b.FIELDNAME, b.DIVID, c.DIVNAME,\n                                a.TASKNO, a.RIPEBCH, a.UNRIPEBCH, a.BLACKBCH, a.ROTTENBCH, \n                                a.LONGSTALKBCH, a.RATDMGBCH, a.LOOSEFRUIT, a.TRANSNO, \n                                a.TRANSDATE, a.TRANSTIME, a.UPLOADDATETIME, a.RECORDTAG, \n                                a.TRANSSTATUS, a.TRANSTYPE, a.LASTUSER, a.LASTUPDATED, \n                                a.OVERRIPEBCH, a.UNDERRIPEBCH, a.ABNORMALBCH, a.LOOSEFRUIT2 \n                         FROM FFBSCANNERDATA{month:02d} a \n                         LEFT JOIN OCFIELD b ON a.FIELDID = b.ID \n                         LEFT JOIN CRDIVISION c ON b.DIVID = c.ID \n                         WHERE a.TRANSDATE >= '{start_date}' AND a.TRANSDATE <= '{end_date}' \n                         ORDER BY a.TRANSDATE, a.TRANSTIME",
      "parameters": [
        "start_date",
        "end_date",
        "month"
      ]
    },
    "division_data": {
      "description": "Get data for specific division with proper JOINs",
      "sql": "SELECT a.ID, a.SCANUSERID, a.OCID, a.WORKERID, a.CARRIERID, \n                                a.FIELDID, b.FIELDNAME, b.DIVID, c.DIVNAME,\n                                a.TASKNO, a.RIPEBCH, a.UNRIPEBCH, a.BLACKBCH, a.ROTTENBCH, \n                                a.LONGSTALKBCH, a.RATDMGBCH, a.LOOSEFRUIT, a.TRANSNO, \n                                a.TRANSDATE, a.TRANSTIME, a.UPLOADDATETIME, a.RECORDTAG, \n                                a.TRANSSTATUS, a.TRANSTYPE, a.LASTUSER, a.LASTUPDATED, \n                                a.OVERRIPEBCH, a.UNDERRIPEBCH, a.ABNORMALBCH, a.LOOSEFRUIT2 \n                         FROM FFBSCANNERDATA{month:02d} a \n                         LEFT JOIN OCFIELD b ON a.FIELDID = b.ID \n                         LEFT JOIN CRDIVISION c ON b.DIVID = c.ID \n                         WHERE b.DIVID = '{div_id}' \n                           AND a.TRANSDATE >= '{start_date}' AND a.TRANSDATE <= '{end_date}' \n                         ORDER BY a.TRANSDATE, a.TRANSTIME",
      "parameters": [
        "div_id",
        "start_date",
        "end_date",
        "month"
      ]
    },
    "daily_summary": {
      "description": "Daily summary of FFB scanner activities",
      "sql": "SELECT a.TRANSDATE, \n                                COUNT(*) as TOTAL_TRANSACTIONS,\n                                SUM(a.RIPEBCH + a.UNRIPEBCH + a.OVERRIPEBCH + a.UNDERRIPEBCH) as TOTAL_BUNCHES,\n                                SUM(a.LOOSEFRUIT + a.LOOSEFRUIT2) as TOTAL_LOOSEFRUIT,\n                                COUNT(DISTINCT a.SCANUSERID) as UNIQUE_SCANNERS\n                         FROM FFBSCANNERDATA{month:02d} a \n                         LEFT JOIN OCFIELD b ON a.FIELDID = b.ID \n                         LEFT JOIN CRDIVISION c ON b.DIVID = c.ID \n                         WHERE a.TRANSDATE >= '{start_date}' AND a.TRANSDATE <= '{end_date}' \n                         GROUP BY a.TRANSDATE \n                         ORDER BY a.TRANSDATE",
      "parameters": [
        "start_date",
        "end_date",
        "month"
      ]
    },
    "scanner_performance": {
      "description": "Performance summary by scanner user",
      "sql": "SELECT a.SCANUSERID, e.\"ID NAME\" as SCANNER_NAME,\n                                COUNT(*) as TOTAL_SCANS,\n                                SUM(a.RIPEBCH + a.UNRIPEBCH + a.OVERRIPEBCH + a.UNDERRIPEBCH) as TOTAL_BUNCHES,\n                                SUM(a.LOOSEFRUIT + a.LOOSEFRUIT2) as TOTAL_LOOSEFRUIT\n                         FROM FFBSCANNERDATA{month:02d} a \n                         LEFT JOIN OCFIELD b ON a.FIELDID = b.ID \n                         LEFT JOIN CRDIVISION c ON b.DIVID = c.ID \n                         LEFT JOIN EMP e ON a.SCANUSERID = e.\"ID EMPCODE\"\n                         WHERE a.TRANSDATE >= '{start_date}' AND a.TRANSDATE <= '{end_date}' \n                         GROUP BY a.SCANUSERID, e.\"ID NAME\" \n                         ORDER BY TOTAL_BUNCHES DESC",
      "parameters": [
        "start_date",
        "end_date",
        "month"
      ]
    },
    "field_performance": {
      "description": "Performance summary by field with division info",
      "sql": "SELECT a.FIELDID, b.FIELDNAME, b.DIVID, c.DIVNAME,\n                                COUNT(*) as TOTAL_TRANSACTIONS,\n                                SUM(a.RIPEBCH + a.UNRIPEBCH + a.OVERRIPEBCH + a.UNDERRIPEBCH) as TOTAL_BUNCHES,\n                                SUM(a.LOOSEFRUIT + a.LOOSEFRUIT2) as TOTAL_LOOSEFRUIT\n                         FROM FFBSCANNERDATA{month:02d} a \n                         LEFT JOIN OCFIELD b ON a.FIELDID = b.ID \n                         LEFT JOIN CRDIVISION c ON b.DIVID = c.ID \n                         WHERE a.TRANSDATE >= '{start_date}' AND a.TRANSDATE <= '{end_date}' \n                         GROUP BY a.FIELDID, b.FIELDNAME, b.DIVID, c.DIVNAME \n                         ORDER BY TOTAL_BUNCHES DESC",
      "parameters": [
        "start_date",
        "end_date",
        "month"
      ]
    },
    "quality_analysis": {
      "description": "Quality analysis of FFB bunches",
      "sql": "SELECT a.TRANSDATE,\n                                SUM(a.RIPEBCH) as RIPE_BUNCHES,\n                                SUM(a.UNRIPEBCH) as UNRIPE_BUNCHES,\n                                SUM(a.OVERRIPEBCH) as OVERRIPE_BUNCHES,\n                                SUM(a.UNDERRIPEBCH) as UNDERRIPE_BUNCHES,\n                                SUM(a.BLACKBCH) as BLACK_BUNCHES,\n                                SUM(a.ROTTENBCH) as ROTTEN_BUNCHES,\n                                SUM(a.LONGSTALKBCH) as LONGSTALK_BUNCHES,\n                                SUM(a.RATDMGBCH) as RATDAMAGE_BUNCHES,\n                                SUM(a.ABNORMALBCH) as ABNORMAL_BUNCHES\n                         FROM FFBSCANNERDATA{month:02d} a \n                         LEFT JOIN OCFIELD b ON a.FIELDID = b.ID \n                         LEFT JOIN CRDIVISION c ON b.DIVID = c.ID \n                         WHERE a.TRANSDATE >= '{start_date}' AND a.TRANSDATE <= '{end_date}' \n                         GROUP BY a.TRANSDATE \n                         ORDER BY a.TRANSDATE",
      "parameters": [
        "start_date",
        "end_date",
        "month"
      ]
    },
    "duplicate_analysis": {
      "description": "Find duplicate transactions for verification analysis",
      "sql": "SELECT a.TRANSNO, COUNT(*) as DUPLICATE_COUNT,\n                                STRING_AGG(a.RECORDTAG, ',') as RECORD_TAGS\n                         FROM FFBSCANNERDATA{month:02d} a \n                         LEFT JOIN OCFIELD b ON a.FIELDID = b.ID \n                         LEFT JOIN CRDIVISION c ON b.DIVID = c.ID \n                         WHERE a.TRANSDATE >= '{start_date}' AND a.TRANSDATE <= '{end_date}' \n                         GROUP BY a.TRANSNO \n                         HAVING COUNT(*) > 1 \n                         ORDER BY DUPLICATE_COUNT DESC",
      "parameters": [
        "start_date",
        "end_date",
        "month"
      ]
    },
    "kerani_mandor_analysis": {
      "description": "Analysis of Kerani (PM) vs Mandor/Asisten verification",
      "sql": "SELECT a.SCANUSERID, a.RECORDTAG, \n                                COUNT(*) as TRANSACTION_COUNT,\n                                SUM(a.RIPEBCH + a.UNRIPEBCH + a.OVERRIPEBCH + a.UNDERRIPEBCH) as TOTAL_BUNCHES\n                         FROM FFBSCANNERDATA{month:02d} a \n                         LEFT JOIN OCFIELD b ON a.FIELDID = b.ID \n                         LEFT JOIN CRDIVISION c ON b.DIVID = c.ID \n                         WHERE a.TRANSDATE >= '{start_date}' AND a.TRANSDATE <= '{end_date}' \n                           AND a.RECORDTAG IN ('PM', 'MN', 'AS') \n                         GROUP BY a.SCANUSERID, a.RECORDTAG \n                         ORDER BY a.SCANUSERID, a.RECORDTAG",
      "parameters": [
        "start_date",
        "end_date",
        "month"
      ]
    },
    "monthly_summary": {
      "description": "Monthly summary statistics",
      "sql": "SELECT EXTRACT(YEAR FROM a.TRANSDATE) as YEAR,\n                                EXTRACT(MONTH FROM a.TRANSDATE) as MONTH,\n                                COUNT(*) as TOTAL_TRANSACTIONS,\n                                SUM(a.RIPEBCH + a.UNRIPEBCH + a.OVERRIPEBCH + a.UNDERRIPEBCH) as TOTAL_BUNCHES,\n                                SUM(a.LOOSEFRUIT + a.LOOSEFRUIT2) as TOTAL_LOOSEFRUIT,\n                                COUNT(DISTINCT a.SCANUSERID) as UNIQUE_SCANNERS\n                         FROM FFBSCANNERDATA{month:02d} a \n                         LEFT JOIN OCFIELD b ON a.FIELDID = b.ID \n                         LEFT JOIN CRDIVISION c ON b.DIVID = c.ID \n                         WHERE a.TRANSDATE >= '{start_date}' AND a.TRANSDATE <= '{end_date}' \n                         GROUP BY EXTRACT(YEAR FROM a.TRANSDATE), EXTRACT(MONTH FROM a.TRANSDATE) \n                         ORDER BY YEAR, MONTH",
      "parameters": [
        "start_date",
        "end_date",
        "month"
      ]
    },
    "verification_status": {
      "description": "Check verification status using TRANSSTATUS field",
      "sql": "SELECT a.TRANSSTATUS, COUNT(*) as STATUS_COUNT,\n                                SUM(a.RIPEBCH + a.UNRIPEBCH + a.OVERRIPEBCH + a.UNDERRIPEBCH) as TOTAL_BUNCHES\n                         FROM FFBSCANNERDATA{month:02d} a \n                         LEFT JOIN OCFIELD b ON a.FIELDID = b.ID \n                         LEFT JOIN CRDIVISION c ON b.DIVID = c.ID \n                         WHERE a.TRANSDATE >= '{start_date}' AND a.TRANSDATE <= '{end_date}' \n                         GROUP BY a.TRANSSTATUS \n                         ORDER BY STATUS_COUNT DESC",
      "parameters": [
        "start_date",
        "end_date",
        "month"
      ]
    },
    "daily_performance": {
      "description": "Daily performance metrics",
      "sql": "SELECT a.TRANSDATE, b.DIVID, c.DIVNAME,\n                                COUNT(*) as TRANSACTIONS,\n                                SUM(a.RIPEBCH + a.UNRIPEBCH + a.OVERRIPEBCH + a.UNDERRIPEBCH) as BUNCHES\n                         FROM FFBSCANNERDATA{month:02d} a \n                         LEFT JOIN OCFIELD b ON a.FIELDID = b.ID \n                         LEFT JOIN CRDIVISION c ON b.DIVID = c.ID \n                         WHERE a.TRANSDATE >= '{start_date}' AND a.TRANSDATE <= '{end_date}' \n                         GROUP BY a.TRANSDATE, b.DIVID, c.DIVNAME \n                         ORDER BY a.TRANSDATE, b.DIVID",
      "parameters": [
        "start_date",
        "end_date",
        "month"
      ]
    },
    "processed_daily_data": {
      "description": "Processed daily data with calculations",
      "sql": "SELECT a.TRANSDATE, \n                                COUNT(*) as TOTAL_TRANSACTIONS,\n                                SUM(a.RIPEBCH) as RIPE_BUNCHES,\n                                SUM(a.UNRIPEBCH + a.OVERRIPEBCH + a.UNDERRIPEBCH) as UNRIPE_BUNCHES,\n                                SUM(a.BLACKBCH + a.ROTTENBCH + a.RATDMGBCH + a.ABNORMALBCH) as DEFECT_BUNCHES\n                         FROM FFBSCANNERDATA{month:02d} a \n                         LEFT JOIN OCFIELD b ON a.FIELDID = b.ID \n                         LEFT JOIN CRDIVISION c ON b.DIVID = c.ID \n                         WHERE a.TRANSDATE >= '{start_date}' AND a.TRANSDATE <= '{end_date}' \n                         GROUP BY a.TRANSDATE \n                         ORDER BY a.TRANSDATE",
      "parameters": [
        "start_date",
        "end_date",
        "month"
      ]
    },
    "employee_performance": {
      "description": "Employee performance analysis",
      "sql": "SELECT a.SCANUSERID, e.\"ID NAME\" as EMPLOYEE_NAME,\n                                COUNT(*) as TOTAL_SCANS,\n                                SUM(a.RIPEBCH + a.UNRIPEBCH + a.OVERRIPEBCH + a.UNDERRIPEBCH) as TOTAL_BUNCHES,\n                                AVG(a.RIPEBCH + a.UNRIPEBCH + a.OVERRIPEBCH + a.UNDERRIPEBCH) as AVG_BUNCHES_PER_SCAN\n                         FROM FFBSCANNERDATA{month:02d} a \n                         LEFT JOIN OCFIELD b ON a.FIELDID = b.ID \n                         LEFT JOIN CRDIVISION c ON b.DIVID = c.ID \n                         LEFT JOIN EMP e ON a.SCANUSERID = e.\"ID EMPCODE\"\n                         WHERE a.TRANSDATE >= '{start_date}' AND a.TRANSDATE <= '{end_date}' \n                         GROUP BY a.SCANUSERID, e.\"ID NAME\" \n                         ORDER BY TOTAL_BUNCHES DESC",
      "parameters": [
        "start_date",
        "end_date",
        "month"
      ]
    },
    "processed_employee_data": {
      "description": "Processed employee data with role analysis",
      "sql": "SELECT a.SCANUSERID, e.\"ID NAME\" as EMPLOYEE_NAME, a.RECORDTAG,\n                                COUNT(*) as TRANSACTION_COUNT,\n                                SUM(a.RIPEBCH + a.UNRIPEBCH + a.OVERRIPEBCH + a.UNDERRIPEBCH) as TOTAL_BUNCHES\n                         FROM FFBSCANNERDATA{month:02d} a \n                         LEFT JOIN OCFIELD b ON a.FIELDID = b.ID \n                         LEFT JOIN CRDIVISION c ON b.DIVID = c.ID \n                         LEFT JOIN EMP e ON a.SCANUSERID = e.\"ID EMPCODE\"\n                         WHERE a.TRANSDATE >= '{start_date}' AND a.TRANSDATE <= '{end_date}' \n                         GROUP BY a.SCANUSERID, e.\"ID NAME\", a.RECORDTAG \n                         ORDER BY a.SCANUSERID, a.RECORDTAG",
      "parameters": [
        "start_date",
        "end_date",
        "month"
      ]
    },
    "processed_field_data": {
      "description": "Processed field data with division grouping",
      "sql": "SELECT a.FIELDID, b.FIELDNAME, b.DIVID, c.DIVNAME,\n                                COUNT(*) as TOTAL_TRANSACTIONS,\n                                SUM(a.RIPEBCH + a.UNRIPEBCH + a.OVERRIPEBCH + a.UNDERRIPEBCH) as TOTAL_BUNCHES,\n                                SUM(a.RIPEBCH) as RIPE_BUNCHES,\n                                SUM(a.UNRIPEBCH + a.OVERRIPEBCH + a.UNDERRIPEBCH) as UNRIPE_BUNCHES\n                         FROM FFBSCANNERDATA{month:02d} a \n                         LEFT JOIN OCFIELD b ON a.FIELDID = b.ID \n                         LEFT JOIN CRDIVISION c ON b.DIVID = c.ID \n                         WHERE a.TRANSDATE >= '{start_date}' AND a.TRANSDATE <= '{end_date}' \n                         GROUP BY a.FIELDID, b.FIELDNAME, b.DIVID, c.DIVNAME \n                         ORDER BY b.DIVID, a.FIELDID",
      "parameters": [
        "start_date",
        "end_date",
        "month"
      ]
    },
    "verification_data": {
      "description": "Verification data analysis",
      "sql": "SELECT a.RECORDTAG, a.TRANSSTATUS,\n                                COUNT(*) as RECORD_COUNT,\n                                SUM(a.RIPEBCH + a.UNRIPEBCH + a.OVERRIPEBCH + a.UNDERRIPEBCH) as TOTAL_BUNCHES\n                         FROM FFBSCANNERDATA{month:02d} a \n                         LEFT JOIN OCFIELD b ON a.FIELDID = b.ID \n                         LEFT JOIN CRDIVISION c ON b.DIVID = c.ID \n                         WHERE a.TRANSDATE >= '{start_date}' AND a.TRANSDATE <= '{end_date}' \n                         GROUP BY a.RECORDTAG, a.TRANSSTATUS \n                         ORDER BY a.RECORDTAG, a.TRANSSTATUS",
      "parameters": [
        "start_date",
        "end_date",
        "month"
      ]
    },
    "ffb_scanner_data": {
      "description": "Complete FFB scanner data for analysis",
      "sql": "SELECT a.*, b.FIELDNAME, b.DIVID, c.DIVNAME, e.\"ID NAME\" as EMPLOYEE_NAME\n                         FROM FFBSCANNERDATA{month:02d} a \n                         LEFT JOIN OCFIELD b ON a.FIELDID = b.ID \n                         LEFT JOIN CRDIVISION c ON b.DIVID = c.ID \n                         LEFT JOIN EMP e ON a.SCANUSERID = e.\"ID EMPCODE\"\n                         WHERE a.TRANSDATE >= '{start_date}' AND a.TRANSDATE <= '{end_date}' \n                         ORDER BY a.TRANSDATE, a.TRANSTIME",
      "parameters": [
        "start_date",
        "end_date",
        "month"
      ]
    }
  },
  "processing_rules": {
    "duplicate_handling": {
      "description": "Remove duplicates based on ID field",
      "method": "drop_duplicates",
      "subset": [
        "ID"
      ]
    },
    "date_filtering": {
      "description": "Filter data within specified date range",
      "field": "TRANSDATE",
      "format": "YYYY-MM-DD"
    },
    "verification_logic": {
      "description": "Special logic for Estate 1A May 2025 - use TRANSSTATUS 704 filter",
      "condition": "estate == 'PGE 1A' and month == 5 and year == 2025",
      "filter": "TRANSSTATUS = '704'"
    }
  },
  "output_format": {
    "employee_details": {
      "structure": {
        "name": "Employee name from mapping",
        "kerani": "Count of PM records created",
        "kerani_verified": "Count of verified PM records",
        "kerani_differences": "Count of input differences",
        "mandor": "Count of MN records",
        "asisten": "Count of AS records"
      }
    },
    "division_summary": {
      "structure": {
        "division_id": "Division ID",
        "division_name": "Division name",
        "total_transactions": "Total transaction count",
        "total_bunches": "Sum of all bunch types",
        "total_loosefruit": "Sum of loose fruit"
      }
    }
  }
}